var valid_img=!1,max_img_width=400,wranges=[max_img_width,Math.round(.8*max_img_width),Math.round(.6*max_img_width),Math.round(.4*max_img_width),Math.round(.2*max_img_width)],pg_form=document.getElementById("personal_group_form");pg_form&&(pg_form.onsubmit=personal_group_submit);var browse_image_btn=document.getElementById("browse_image_btn");function detect_android_ver(){var e=navigator.userAgent;return e.indexOf("Android")>=0?parseFloat(e.slice(e.indexOf("Android")+8)):100}function personal_group_preloader(e){switch(e){case"create":(t=document.createElement("div")).id="personal_group_overlay",t.className="ovl",(a=document.createElement("div")).id="personal_group_preloader",a.className="outer_ldr";var r=document.createElement("div");r.className="ldr ma",(i=document.createElement("div")).id="preloader_message",i.className="cap sp cs cgy mbl",i.innerHTML="- resizing foto -",document.body.appendChild(t),document.body.appendChild(a),a.insertAdjacentElement("afterbegin",r),a.insertAdjacentElement("afterbegin",i),document.body.style.overflow="hidden";break;case"update":(i=document.getElementById("preloader_message"))&&(i.innerHTML="- posting foto -");break;case"finishing":var i;(i=document.getElementById("preloader_message"))&&(i.innerHTML="- finishing -");break;case"destroy":var t=document.getElementById("personal_group_overlay"),a=document.getElementById("personal_group_preloader");t&&t.parentNode.removeChild(t),a&&a.parentNode.removeChild(a),document.body.style.overflow="visible"}}function show_image_name(e){if("[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&e.target.files){document.getElementById("main_cam").style.display="none";var r=document.getElementById("filename");r.innerHTML=e.target.value.replace(/^.*[\\\/]/,"").slice(0,20),r.style.display="block",e.target.files[0].size<20000001?window.FileReader&&window.Blob&&validate_img_file(e):throw_err(e.target,"size","pg_main")}}function validate_img_file(e){is_pub_grp_img?pub_grp_subform.disabled=!0:is_pub_img?pub_img_subform.disabled=!0:is_reply?rep_subform.disabled=!0:subform.disabled=!0;var r=e.target.files[0],i=new FileReader;i.onload=validate_file,i.readAsArrayBuffer(r.slice(0,4))}function validate_file(e){for(var r="",i=new Uint8Array(e.target.result),t=0;t<i.length;t++)r+=i[t].toString(16);switch(r){case"89504e47":is_pub_grp_img?valid_pub_grp_img="png":is_pub_img?valid_public_img="png":is_reply?valid_rep_img="png":valid_img="png";break;case"47494638":is_pub_grp_img?valid_pub_grp_img="gif":is_pub_img?valid_public_img="gif":is_reply?valid_rep_img="gif":valid_img="gif";break;case"ffd8ffe0":case"ffd8ffe1":case"ffd8ffe2":case"ffd8ffe3":case"ffd8ffe8":case"ffd8ffdb":is_pub_grp_img?valid_pub_grp_img="jpeg":is_pub_img?valid_public_img="jpeg":is_reply?valid_rep_img="jpeg":valid_img="jpeg";break;default:is_pub_grp_img?throw_err(pub_grp_browse_image_btn,"mime","pub_grp_img"):is_pub_img?(valid_public_img=null,throw_err(browse_pub_img_btn,"mime","public_img")):is_reply?(valid_rep_img=null,throw_err(browse_rep_image_btn,"mime","pg_reply")):throw_err(browse_image_btn,"mime","pg_main")}is_pub_grp_img?(pub_grp_subform.disabled=!1,is_pub_grp_img=!1):is_pub_img?(pub_img_subform.disabled=!1,is_pub_img=!1):is_reply?(rep_subform.disabled=!1,is_reply=!1):subform.disabled=!1}function process_ajax(e,r,i,t,a,n,o,_,l,p){var s=new FormData;e&&s.append(l,e),a&&s.append("resized","1"),n&&s.append("reoriented","1"),"pg_main"===o?(s.append("tid",document.getElementById("tid").value),s.append("sk",document.getElementById("sk").value)):"public_img"===o?s.append("sk",document.getElementById("pub_img_sk").value):"pg_reply"===o?rep_payload&&s.append("pl",rep_payload):(s.append("gp",document.getElementById("pub_grp_subform").value),s.append("sk",document.getElementById("pub_grp_sk").value)),s.append(_,t,r),personal_group_preloader("update");var g=new XMLHttpRequest;g.open("POST",i),g.timeout=45e3,g.setRequestHeader("X-CSRFToken",get_cookie("csrftoken")),g.setRequestHeader("X-Requested-With","XMLHttpRequest"),g.onload=function(){if(200==this.status){var e=JSON.parse(this.responseText);window.location.replace(e.message),personal_group_preloader("destroy")}else window.location.replace("/missing/"),personal_group_preloader("destroy")},g.onerror=function(){window.location.replace(p),personal_group_preloader("destroy")},g.onprogress=function(){personal_group_preloader("finishing")},g.ontimeout=function(e){window.location.replace(p),personal_group_preloader("destroy")},g.send(s)}function personal_group_submit(e){!browse_image_btn.files[0]||!valid_img||detect_android_ver()<4.1||(e.preventDefault(),personal_group_preloader("create"),prep_image(browse_image_btn.files[0],text_field.value,browse_image_btn.files[0].name,e.target.action,"pg_main","image","reply","/private_chat/",null,process_ajax))}function prep_image(e,r,i,t,a,n,o,_,l,p){get_orientation(e,a,function(s){var g=document.createElement("img"),d=new FileReader;d.onload=function(){var m=d.result;g.onload=function(){img_width=this.width,img_height=this.height,img_to_send=resize_and_compress(this,img_width,img_height,"image/jpeg",s,l),img_to_send.size>e.size?p(r,i,t,e,!1,!1,a,n,o,_):p(r,i,t,img_to_send,!0,!0,a,n,o,_)},g.onerror=function(){window.location.href=window.location.href,personal_group_preloader("destroy")},g.src=m},d.readAsDataURL(e)})}function resize_and_compress(e,r,i,t,a,n){switch(a){case 2:case 3:case 4:break;case 5:case 6:case 7:case 8:var o;o=r,r=i,i=o}var _=null;if(n)_=n;else switch(!0){case r<wranges[4]:case r<wranges[3]:_=wranges[4];break;case r<wranges[2]:_=wranges[3];break;case r<wranges[1]:_=wranges[2];break;case r<wranges[0]:_=wranges[1];break;default:_=wranges[0]}var l=_/r,p=Math.round(i*l),s=document.createElement("canvas");s.width=_,s.height=p;var g=s.getContext("2d");switch(a){case 2:g.translate(_,0),g.scale(-1,1);break;case 3:g.translate(_,p),g.rotate(-Math.PI);break;case 4:g.translate(0,p),g.scale(1,-1);break;case 5:g.rotate(.5*Math.PI),g.scale(p/_,-_/p);break;case 6:g.rotate(.5*Math.PI),g.translate(0,-_),g.scale(p/_,_/p);break;case 7:g.rotate(.5*Math.PI),g.translate(p,-_),g.scale(-p/_,_/p);break;case 8:g.translate(0,p),g.scale(_/p,p/_),g.rotate(-.5*Math.PI)}return g.drawImage(e,0,0,_,p),dataURItoBlob(s.toDataURL(t),t)}function dataURItoBlob(e,r){for(var i=atob(e.split(",")[1]),t=new ArrayBuffer(i.length),a=new Uint8Array(t),n=0;n<i.length;n++)a[n]=i.charCodeAt(n);return new Blob([t],{type:r})}function get_cookie(e){if(!e)return null;var r=("; "+document.cookie).split("; "+e+"=");return r.length>=2?r.pop().split(";").shift():void 0}function throw_err(e,r,i){if("pub_grp_img"==i){if("size"==r)var t=document.getElementById("pub_grp_img_size_err");else t=document.getElementById("pub_grp_img_mime_err");pub_grp_form.insertAdjacentElement("afterbegin",t)}else if("public_img"==i){if("size"==r)t=document.getElementById("pub_img_size_err");else t=document.getElementById("pub_img_mime_err");public_photo_form.insertAdjacentElement("afterbegin",t)}else if("pg_reply"==i){if("size"==r)t=document.getElementById("pg_rep_size_err");else t=document.getElementById("pg_rep_mime_err");form_template.insertAdjacentElement("afterbegin",t)}else{var a=document.getElementById("personal_group_top");if("size"==r)t=document.getElementById("pg_size_err");else t=document.getElementById("pg_mime_err");a&&(a.innerHTML="",a.insertAdjacentElement("afterbegin",t))}t.style.display=null,e.value=""}function get_orientation(e,r,i){if("pg_reply"===r){if("jpeg"!=valid_rep_img)return i(-2)}else if("pub_grp_img"===r){if("jpeg"!=valid_pub_grp_img)return i(-2)}else if("public_img"===r){if("jpeg"!=valid_public_img)return i(-2)}else if("jpeg"!=valid_img)return i(-2);var t=new FileReader;t.onload=function(e){var r=new DataView(e.target.result);if(65496!=r.getUint16(0,!1))return i(-2);for(var t=r.byteLength,a=2;a<t;){if(r.getUint16(a+2,!1)<=8)return i(-1);var n=r.getUint16(a,!1);if(a+=2,65505==n){if(1165519206!=r.getUint32(a+=2,!1))return i(-1);var o=18761==r.getUint16(a+=6,!1);a+=r.getUint32(a+4,o);var _=r.getUint16(a,o);a+=2;for(var l=0;l<_;l++)if(274==r.getUint16(a+12*l,o))return i(r.getUint16(a+12*l+8,o))}else{if(65280!=(65280&n))break;a+=r.getUint16(a,!1)}}return i(-1)},t.readAsArrayBuffer(e.slice(0,131072))}browse_image_btn&&(browse_image_btn.onchange=show_image_name),Blob=function(){var e=Blob;return Blob.prototype.webkitSlice?Blob.prototype.slice=Blob.prototype.webkitSlice:Blob.prototype.mozSlice&&(Blob.prototype.slice=Blob.prototype.mozSlice),function(r,i){try{return Blob=e,new Blob(r||[],i||{})}catch(e){Blob=function(e,r){var i,t=new(WebKitBlobBuilder||MozBlobBuilder);for(i in e)t.append(e[i]);return t.getBlob(r&&r.type?r.type:void 0)}}}}();var is_reply=!1,valid_rep_img=!1,rep_payload=null;function show_rep_image_name(e){if("[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&e.target.files){var r=e.target.value.replace(/^.*[\\\/]/,"").slice(0,20),i=e.target.form,t=i.querySelector("#rep_filename"),a=i.querySelector("#rep_cam"),n=i.querySelector("#rep_ok_btn"),o=i.querySelector("#modal_top");if(n.disabled=!0,e.target.files[0].size<20000001){if(window.FileReader&&window.Blob){var _=e.target.files[0],l=new FileReader;l.onload=function(e){for(var i="",_=new Uint8Array(e.target.result),l=0;l<_.length;l++)i+=_[l].toString(16);switch(i){case"89504e47":valid_rep_img="png",o.className="sp cs mbs cgy",o.innerHTML="Jawab:",n.onclick=personal_group_reply_submit,n.disabled=!1;break;case"47494638":valid_rep_img="gif",o.className="sp cs mbs cgy",o.innerHTML="Jawab:",n.onclick=personal_group_reply_submit,n.disabled=!1;break;case"ffd8ffe0":case"ffd8ffe1":case"ffd8ffe2":case"ffd8ffe3":case"ffd8ffe8":case"ffd8ffdb":valid_rep_img="jpeg",o.className="sp cs mbs cgy",o.innerHTML="Jawab:",n.onclick=personal_group_reply_submit,n.disabled=!1;break;default:valid_rep_img=null,o.className="cr lsp",o.innerHTML="Ye foto kharab hai, koi aur chunein"}t.innerHTML=r,a.style.display="none",t.style.display="flex"},l.readAsArrayBuffer(_.slice(0,4))}}else valid_rep_img=null,o.className="cr lsp",o.innerHTML="Ye foto buhut barri hai, choti foto chunein"}}function personal_group_reply_submit(e){if(!("[object OperaMini]"===Object.prototype.toString.call(window.operamini)||detect_android_ver()<4.1)){if(!valid_rep_img)return null==valid_rep_img?void e.preventDefault():void 0;e.preventDefault();var r=e.target.form,i=r.querySelector("#browse_rep_image_btn").files[0],t=r.querySelector("#rep_text_field").value,a=r.action;rep_payload=e.target.value,personal_group_preloader("create"),prep_image(i,t,i.name,a,"pg_reply","rep_image","rep_reply","/private_chat/",null,process_ajax)}}var is_pub_img=!1,valid_public_img=!1,public_photo_form=document.getElementById("public_photo_form");public_photo_form&&(public_photo_form.onsubmit=public_photo_submit);var public_photo_upload_btn=document.getElementById("browse_pub_img_btn");function validate_public_image(e){"[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&e.target.files&&(document.getElementById("pub_img_size_err").style.display="none",document.getElementById("pub_img_mime_err").style.display="none",e.target.files[0].size<20000001?window.FileReader&&window.Blob&&(is_pub_img=!0,validate_img_file(e)):(valid_public_img=null,throw_err(e.target,"size","public_img")))}function public_photo_submit(e){if(!(detect_android_ver()<4.1))return valid_public_img?(e.preventDefault(),personal_group_preloader("create"),void prep_image(browse_pub_img_btn.files[0],pub_img_caption_field.value,browse_pub_img_btn.files[0].name,e.target.action,"public_img","image_file","caption","/upload_public_photo/",400,process_ajax)):null==valid_public_img?void e.preventDefault():void 0}public_photo_upload_btn&&(public_photo_upload_btn.onchange=validate_public_image);var is_pub_grp_img=!1,valid_pub_grp_img=!1,pub_grp_form=document.getElementById("pub_grp_form");pub_grp_form&&(pub_grp_form.onsubmit=pub_grp_form_submit);var pub_grp_browse_image_btn=document.getElementById("pub_grp_browse_image_btn");function validate_pub_grp_img(e){"[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&e.target.files&&(document.getElementById("pub_grp_img_size_err").style.display="none",document.getElementById("pub_grp_img_mime_err").style.display="none",e.target.files[0].size<20000001?window.FileReader&&window.Blob&&(is_pub_grp_img=!0,validate_img_file(e)):throw_err(e.target,"size","pub_grp_img"))}function pub_grp_form_submit(e){detect_android_ver()<4.1||valid_pub_grp_img&&(e.preventDefault(),personal_group_preloader("create"),prep_image(pub_grp_browse_image_btn.files[0],pub_grp_text_field.value,pub_grp_browse_image_btn.files[0].name,e.target.action,"pub_grp_img","image","text","/mehfil/awami/",400,process_ajax))}pub_grp_browse_image_btn&&(pub_grp_browse_image_btn.onchange=validate_pub_grp_img);