var valid_img=!1,max_img_width=400,wranges=[max_img_width,Math.round(.8*max_img_width),Math.round(.6*max_img_width),Math.round(.4*max_img_width),Math.round(.2*max_img_width)],pg_form=document.getElementById("personal_group_form");pg_form&&(pg_form.onsubmit=personal_group_submit);var browse_image_btn=document.getElementById("browse_image_btn");function detect_android_ver(){var e=navigator.userAgent;return e.indexOf("Android")>=0?parseFloat(e.slice(e.indexOf("Android")+8)):100}function personal_group_preloader(e){switch(e){case"create":(r=document.createElement("div")).id="personal_group_overlay",r.className="ovl",(a=document.createElement("div")).id="personal_group_preloader",a.className="outer_ldr";var t=document.createElement("div");t.className="ldr ma",(i=document.createElement("div")).id="preloader_message",i.className="cap sp cs cgy mbl",i.insertAdjacentText("afterbegin","- resizing foto -"),document.body.appendChild(r),document.body.appendChild(a),a.insertAdjacentElement("afterbegin",t),a.insertAdjacentElement("afterbegin",i),document.body.style.overflow="hidden";break;case"update":(i=document.getElementById("preloader_message"))&&(i.innerHTML="- posting foto -");break;case"finishing":var i;(i=document.getElementById("preloader_message"))&&(i.innerHTML="- finishing -");break;case"destroy":var r=document.getElementById("personal_group_overlay"),a=document.getElementById("personal_group_preloader");r&&r.parentNode.removeChild(r),a&&a.parentNode.removeChild(a),document.body.style.overflow="visible"}}function show_image_name(e){if("[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&e.target.files){document.getElementById("main_cam").style.display="none";var t=document.getElementById("filename");t.insertAdjacentText("afterbegin",e.target.value.replace(/^.*[\\\/]/,"").slice(0,20)),t.style.display="block",e.target.files[0].size<20000001?window.FileReader&&window.Blob&&validate_img_file(e):throw_err(e.target,"size","pg_main")}}function validate_img_file(e){is_pub_grp_img?pub_grp_subform.disabled=!0:is_pub_img?pub_img_subform.disabled=!0:is_reply?rep_subform.disabled=!0:subform.disabled=!0;var t=e.target.files[0],i=new FileReader;i.onload=validate_file,i.readAsArrayBuffer(t.slice(0,4))}function validate_file(e){for(var t="",i=new Uint8Array(e.target.result),r=0;r<i.length;r++)t+=i[r].toString(16);switch(t){case"89504e47":is_pub_grp_img?valid_pub_grp_img="png":is_pub_img?valid_public_img="png":is_reply?valid_rep_img="png":valid_img="png";break;case"47494638":is_pub_grp_img?valid_pub_grp_img="gif":is_pub_img?valid_public_img="gif":is_reply?valid_rep_img="gif":valid_img="gif";break;case"ffd8ffe0":case"ffd8ffe1":case"ffd8ffe2":case"ffd8ffe3":case"ffd8ffe8":case"ffd8ffdb":is_pub_grp_img?valid_pub_grp_img="jpeg":is_pub_img?valid_public_img="jpeg":is_reply?valid_rep_img="jpeg":valid_img="jpeg";break;default:is_pub_grp_img?throw_err(pub_grp_browse_image_btn,"mime","pub_grp_img"):is_pub_img?(valid_public_img=null,throw_err(browse_pub_img_btn,"mime","public_img")):is_reply?(valid_rep_img=null,throw_err(browse_rep_image_btn,"mime","pg_reply")):throw_err(browse_image_btn,"mime","pg_main")}is_pub_grp_img?(pub_grp_subform.disabled=!1,is_pub_grp_img=!1):is_pub_img?(pub_img_subform.disabled=!1,is_pub_img=!1):is_reply?(rep_subform.disabled=!1,is_reply=!1):subform.disabled=!1}function process_ajax(e,t,i,r,a,n,_,l,p,o){var d=new FormData;e&&d.append(p,e),a&&d.append("resized","1"),n&&d.append("reoriented","1"),"pg_main"===_?(d.append("tid",document.getElementById("tid").value),d.append("sk",document.getElementById("sk").value)):"public_img"===_?d.append("sk",document.getElementById("pub_img_sk").value):"pg_reply"===_?(d.append("tt",rep_tt),d.append("bid",rep_bid),d.append("idx",rep_idx),d.append("tid",rep_tid),d.append("sk",rep_sk)):(d.append("gp",document.getElementById("pub_grp_subform").value),d.append("sk",document.getElementById("pub_grp_sk").value)),d.append(l,r,t),personal_group_preloader("update");var m=new XMLHttpRequest;m.open("POST",i),m.timeout=45e3,m.setRequestHeader("X-CSRFToken",get_cookie("csrftoken")),m.setRequestHeader("X-Requested-With","XMLHttpRequest"),m.onload=function(){if(200==this.status){var e=JSON.parse(this.responseText);window.location.replace(e.message),personal_group_preloader("destroy")}else window.location.replace("/missing/"),personal_group_preloader("destroy")},m.onerror=function(){window.location.replace(o),personal_group_preloader("destroy")},m.onprogress=function(){personal_group_preloader("finishing")},m.ontimeout=function(e){window.location.replace(o),personal_group_preloader("destroy")},m.send(d)}function personal_group_submit(e){!browse_image_btn.files[0]||!valid_img||detect_android_ver()<4.1||(e.preventDefault(),personal_group_preloader("create"),prep_image(browse_image_btn.files[0],text_field.value,browse_image_btn.files[0].name,e.target.action,"pg_main","image","reply","/private_chat/",null,process_ajax))}function prep_image(e,t,i,r,a,n,_,l,p,o){get_orientation(e,a,function(d){var m=document.createElement("img"),s=new FileReader;s.onload=function(){var g=s.result;m.onload=function(){img_width=this.width,img_height=this.height,img_to_send=resize_and_compress(this,img_width,img_height,"image/jpeg",d,p),img_to_send.size>e.size?o(t,i,r,e,!1,!1,a,n,_,l):o(t,i,r,img_to_send,!0,!0,a,n,_,l)},m.onerror=function(){window.location.href=window.location.href,personal_group_preloader("destroy")},m.src=g},s.readAsDataURL(e)})}function resize_and_compress(e,t,i,r,a,n){switch(a){case 2:case 3:case 4:break;case 5:case 6:case 7:case 8:var _;_=t,t=i,i=_}var l=null;if(n)l=n;else switch(!0){case t<wranges[4]:case t<wranges[3]:l=wranges[4];break;case t<wranges[2]:l=wranges[3];break;case t<wranges[1]:l=wranges[2];break;case t<wranges[0]:l=wranges[1];break;default:l=wranges[0]}var p=l/t,o=Math.round(i*p),d=document.createElement("canvas");d.width=l,d.height=o;var m=d.getContext("2d");switch(a){case 2:m.translate(l,0),m.scale(-1,1);break;case 3:m.translate(l,o),m.rotate(-Math.PI);break;case 4:m.translate(0,o),m.scale(1,-1);break;case 5:m.rotate(.5*Math.PI),m.scale(o/l,-l/o);break;case 6:m.rotate(.5*Math.PI),m.translate(0,-l),m.scale(o/l,l/o);break;case 7:m.rotate(.5*Math.PI),m.translate(o,-l),m.scale(-o/l,l/o);break;case 8:m.translate(0,o),m.scale(l/o,o/l),m.rotate(-.5*Math.PI)}return m.drawImage(e,0,0,l,o),dataURItoBlob(d.toDataURL(r),r)}function dataURItoBlob(e,t){for(var i=atob(e.split(",")[1]),r=new ArrayBuffer(i.length),a=new Uint8Array(r),n=0;n<i.length;n++)a[n]=i.charCodeAt(n);return new Blob([r],{type:t})}function get_cookie(e){if(!e)return null;var t=("; "+document.cookie).split("; "+e+"=");return t.length>=2?t.pop().split(";").shift():void 0}function throw_err(e,t,i){if("pub_grp_img"==i){if("size"==t)var r=document.getElementById("pub_grp_img_size_err");else r=document.getElementById("pub_grp_img_mime_err");pub_grp_form.insertAdjacentElement("afterbegin",r)}else if("public_img"==i){if("size"==t)r=document.getElementById("pub_img_size_err");else r=document.getElementById("pub_img_mime_err");public_photo_form.insertAdjacentElement("afterbegin",r)}else if("pg_reply"==i){if("size"==t)r=document.getElementById("pg_rep_size_err");else r=document.getElementById("pg_rep_mime_err");form_template.insertAdjacentElement("afterbegin",r)}else{var a=document.getElementById("personal_group_top");if("size"==t)r=document.getElementById("pg_size_err");else r=document.getElementById("pg_mime_err");a&&(a.innerHTML="",a.insertAdjacentElement("afterbegin",r))}r.style.display=null,e.value=""}function get_orientation(e,t,i){if("pg_reply"===t){if("jpeg"!=valid_rep_img)return i(-2)}else if("pub_grp_img"===t){if("jpeg"!=valid_pub_grp_img)return i(-2)}else if("public_img"===t){if("jpeg"!=valid_public_img)return i(-2)}else if("jpeg"!=valid_img)return i(-2);var r=new FileReader;r.onload=function(e){var t=new DataView(e.target.result);if(65496!=t.getUint16(0,!1))return i(-2);for(var r=t.byteLength,a=2;a<r;){if(t.getUint16(a+2,!1)<=8)return i(-1);var n=t.getUint16(a,!1);if(a+=2,65505==n){if(1165519206!=t.getUint32(a+=2,!1))return i(-1);var _=18761==t.getUint16(a+=6,!1);a+=t.getUint32(a+4,_);var l=t.getUint16(a,_);a+=2;for(var p=0;p<l;p++)if(274==t.getUint16(a+12*p,_))return i(t.getUint16(a+12*p+8,_))}else{if(65280!=(65280&n))break;a+=t.getUint16(a,!1)}}return i(-1)},r.readAsArrayBuffer(e.slice(0,131072))}browse_image_btn&&(browse_image_btn.onchange=show_image_name),Blob=function(){var e=Blob;return Blob.prototype.webkitSlice?Blob.prototype.slice=Blob.prototype.webkitSlice:Blob.prototype.mozSlice&&(Blob.prototype.slice=Blob.prototype.mozSlice),function(t,i){try{return Blob=e,new Blob(t||[],i||{})}catch(e){Blob=function(e,t){var i,r=new(WebKitBlobBuilder||MozBlobBuilder);for(i in e)r.append(e[i]);return r.getBlob(t&&t.type?t.type:void 0)}}}}();var form_template=document.getElementById("form_template");if(form_template){var rep_size=form_template.firstElementChild.nextElementSibling,rep_mime=form_template.firstElementChild.nextElementSibling.nextElementSibling;form_template.onsubmit=personal_group_reply_submit}var rep_text_field=document.getElementById("rep_text_field");rep_text_field&&(rep_text_field.onfocus=remove_placeholder);var browse_rep_image_btn=document.getElementById("browse_rep_image_btn");browse_rep_image_btn&&(browse_rep_image_btn.onchange=show_rep_image_name);for(var rep_btns=document.getElementsByClassName("rep"),i=0,len=rep_btns.length;i<len;i++)rep_btns[i].onclick=toggle_rep;var is_reply=!1,valid_rep_img=!1,rep_tt=null,rep_bid=null,rep_idx=null,rep_tid=null,rep_sk=null;function remove_placeholder(e){this.placeholder=""}function show_rep_image_name(e){if("[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&e.target.files){var t=e.target.value.replace(/^.*[\\\/]/,"").slice(0,20),i=document.getElementById("rep_filename"),r=document.getElementById("rep_cam"),a=document.getElementById("rep_subform");if(a.disabled=!0,e.target.files[0].size<20000001){if(window.FileReader&&window.Blob){var n=e.target.files[0],_=new FileReader;_.onload=function(e){for(var n="",_=new Uint8Array(e.target.result),l=0;l<_.length;l++)n+=_[l].toString(16);switch(n){case"89504e47":valid_rep_img="png",rep_size.style.display="none",rep_mime.style.display="none",a.disabled=!1;break;case"47494638":valid_rep_img="gif",rep_size.style.display="none",rep_mime.style.display="none",a.disabled=!1;break;case"ffd8ffe0":case"ffd8ffe1":case"ffd8ffe2":case"ffd8ffe3":case"ffd8ffe8":case"ffd8ffdb":valid_rep_img="jpeg",rep_size.style.display="none",rep_mime.style.display="none",a.disabled=!1;break;default:valid_rep_img=null,rep_size.style.display="none",rep_mime.style.display="block"}i.innerHTML=t,r.style.display="none",i.style.display="flex"},_.readAsArrayBuffer(n.slice(0,4))}}else valid_rep_img=null,rep_mime.style.display="none",rep_size.style.display="block"}}function personal_group_reply_submit(e){if(!("[object OperaMini]"===Object.prototype.toString.call(window.operamini)||detect_android_ver()<4.1)){if(!valid_rep_img)return null==valid_rep_img?void e.preventDefault():void 0;e.preventDefault();var t=browse_rep_image_btn.files[0],i=document.getElementById("rep_text_field").value,r=form_template.action;rep_tt=document.getElementById("rep_tt").value,rep_bid=document.getElementById("rep_bid").value,rep_idx=document.getElementById("rep_idx").value,rep_tid=document.getElementById("rep_tid").value,rep_sk=document.getElementById("rep_sk").value,personal_group_preloader("create"),prep_image(t,i,t.name,r,"pg_reply","rep_image","rep_reply","/private_chat/",null,process_ajax)}}function toggle_rep(e){if(form_template&&"[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&!(detect_android_ver()<4.1)){e.preventDefault();var t=this.form,i=t.firstElementChild.nextElementSibling.value.split(":"),r=i[4],a=i[0],n=i[2],_=t.nextElementSibling;null==_?(empty_input_fields(),t.insertAdjacentElement("afterend",form_template),populate_input_fields(r,a,n),form_template.style.display="inline"):null!=_&&"form_template"==_.id&&"inline"==form_template.style.display?(form_template.style.display="none",empty_input_fields()):(empty_input_fields(),t.insertAdjacentElement("afterend",form_template),populate_input_fields(r,a,n),form_template.style.display="inline")}}function populate_input_fields(e,t,i){document.getElementById("rep_tt").value=e,document.getElementById("rep_bid").value=t,document.getElementById("rep_idx").value=i}function empty_input_fields(){document.getElementById("rep_tt").value="",document.getElementById("rep_bid").value="",document.getElementById("rep_idx").value=""}var is_pub_img=!1,valid_public_img=!1,public_photo_form=document.getElementById("public_photo_form");public_photo_form&&(public_photo_form.onsubmit=public_photo_submit);var public_photo_upload_btn=document.getElementById("browse_pub_img_btn");function validate_public_image(e){"[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&e.target.files&&(document.getElementById("pub_img_size_err").style.display="none",document.getElementById("pub_img_mime_err").style.display="none",e.target.files[0].size<20000001?window.FileReader&&window.Blob&&(is_pub_img=!0,validate_img_file(e)):(valid_public_img=null,throw_err(e.target,"size","public_img")))}function public_photo_submit(e){if(!(detect_android_ver()<4.1))return valid_public_img?(e.preventDefault(),personal_group_preloader("create"),void prep_image(browse_pub_img_btn.files[0],pub_img_caption_field.value,browse_pub_img_btn.files[0].name,e.target.action,"public_img","image_file","caption","/upload_public_photo/",400,process_ajax)):null==valid_public_img?void e.preventDefault():void 0}public_photo_upload_btn&&(public_photo_upload_btn.onchange=validate_public_image);var is_pub_grp_img=!1,valid_pub_grp_img=!1,pub_grp_form=document.getElementById("pub_grp_form");pub_grp_form&&(pub_grp_form.onsubmit=pub_grp_form_submit);var pub_grp_browse_image_btn=document.getElementById("pub_grp_browse_image_btn");function validate_pub_grp_img(e){"[object OperaMini]"!==Object.prototype.toString.call(window.operamini)&&e.target.files&&(document.getElementById("pub_grp_img_size_err").style.display="none",document.getElementById("pub_grp_img_mime_err").style.display="none",e.target.files[0].size<20000001?window.FileReader&&window.Blob&&(is_pub_grp_img=!0,validate_img_file(e)):throw_err(e.target,"size","pub_grp_img"))}function pub_grp_form_submit(e){detect_android_ver()<4.1||valid_pub_grp_img&&(e.preventDefault(),personal_group_preloader("create"),prep_image(pub_grp_browse_image_btn.files[0],pub_grp_text_field.value,pub_grp_browse_image_btn.files[0].name,e.target.action,"pub_grp_img","image","text","/mehfil/awami/",400,process_ajax))}pub_grp_browse_image_btn&&(pub_grp_browse_image_btn.onchange=validate_pub_grp_img);